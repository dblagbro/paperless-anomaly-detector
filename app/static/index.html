<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paperless Anomaly Detector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        header p {
            opacity: 0.8;
            margin-top: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-card.anomaly .value {
            color: #e74c3c;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filters h2 {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .filter-group input, .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        button.primary {
            background: #3498db;
            color: white;
        }

        button.primary:hover {
            background: #2980b9;
        }

        button.secondary {
            background: #95a5a6;
            color: white;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        button.success {
            background: #27ae60;
            color: white;
        }

        button.success:hover {
            background: #229954;
        }

        .documents-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .documents-table h2 {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .badge.anomaly {
            background: #fee;
            color: #c0392b;
        }

        .badge.severity-low {
            background: #f0f8e8;
            color: #6b8e23;
        }

        .badge.severity-medium {
            background: #fff3cd;
            color: #d68910;
        }

        .badge.severity-high {
            background: #ffe6e6;
            color: #c0392b;
        }

        .badge.severity-critical {
            background: #ffcccc;
            color: #8b0000;
            font-weight: 600;
        }

        .badge.clean {
            background: #e8f8f5;
            color: #27ae60;
        }

        .badge.warning {
            background: #fef5e7;
            color: #f39c12;
        }

        .status-pass {
            color: #27ae60;
            font-weight: 600;
        }

        .status-fail {
            color: #e74c3c;
            font-weight: 600;
        }

        .status-warning {
            color: #f39c12;
            font-weight: 600;
        }

        .link {
            color: #3498db;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 30px;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
        }

        .close-modal {
            font-size: 32px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 32px;
            text-align: center;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-body {
            color: #333;
            line-height: 1.6;
        }

        .anomaly-detail-section {
            margin-bottom: 20px;
        }

        .anomaly-detail-section h3 {
            font-size: 16px;
            color: #555;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .anomaly-detail-list {
            background: #f8f9fa;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .anomaly-detail-list code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
            color: #c0392b;
        }

        .anomaly-detail-list ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .anomaly-detail-list li {
            margin: 5px 0;
        }

        .badge.clickable {
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .badge.clickable:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üìä Paperless Anomaly Detector</h1>
            <p>Automated financial document analysis and anomaly detection</p>
        </div>
    </header>

    <div class="container">
        <!-- Statistics -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <h3>Total Documents</h3>
                <div class="value" id="stat-total">-</div>
            </div>
            <div class="stat-card anomaly">
                <h3>With Anomalies</h3>
                <div class="value" id="stat-anomalies">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Flags</h3>
                <div class="value" id="stat-flags">-</div>
            </div>
            <div class="stat-card">
                <h3>Detection Rate</h3>
                <div class="value" id="stat-rate">-</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <h2>üîç Filters</h2>
            <div class="filter-grid">
                <div class="filter-group" style="grid-column: span 2;">
                    <label>Anomaly Types (select multiple)</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="anomaly-type-filter" value="balance_mismatch"> Balance Mismatch
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="anomaly-type-filter" value="layout_irregularity"> Layout Irregularity
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="anomaly-type-filter" value="duplicate_lines"> Duplicate Lines
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="anomaly-type-filter" value="truncated_total"> Truncated Total
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="anomaly-type-filter" value="reversed_columns"> Reversed Columns
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="anomaly-type-filter" value="page_discontinuity"> Page Discontinuity
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="anomaly-type-filter" value="check_sequence_gap"> Check Sequence Gap
                        </label>
                    </div>
                </div>
                <div class="filter-group">
                    <label>Min Amount ($)</label>
                    <input type="number" id="filter-min-amount" placeholder="0.00" step="0.01">
                </div>
                <div class="filter-group">
                    <label>Max Amount ($)</label>
                    <input type="number" id="filter-max-amount" placeholder="1000.00" step="0.01">
                </div>
                <div class="filter-group">
                    <label>Date From</label>
                    <input type="date" id="filter-date-from">
                </div>
                <div class="filter-group">
                    <label>Date To</label>
                    <input type="date" id="filter-date-to">
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filter-has-anomalies">
                        <option value="">All Documents</option>
                        <option value="true">Only Anomalies</option>
                        <option value="false">Only Clean</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Per Page</label>
                    <select id="page-size">
                        <option value="10">10</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all" selected>All</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="primary" onclick="applyFilters()">Apply Filters</button>
                <button class="secondary" onclick="clearFilters()">Clear</button>
                <button class="success" onclick="triggerScan()">üîÑ Scan Now</button>
            </div>
        </div>

        <!-- Documents Table -->
        <div class="documents-table">
            <h2>üìÑ Processed Documents</h2>
            <div id="table-container">
                <div class="loading">Loading documents...</div>
            </div>
        </div>
    </div>

    <!-- Anomaly Details Modal -->
    <div id="anomaly-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Anomaly Details</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Details will be inserted here -->
            </div>
        </div>
    </div>

    <script>
// API base URL - use absolute path for NGINX proxy
const API_BASE = '/paperless-anomaly-detector';

// State
let currentFilters = {};
let currentOffset = 0;
let totalDocuments = 0;
let documentsCache = {}; // Store full document data for modal access

// Get current page size from selector
function getPageSize() {
    const pageSize = document.getElementById('page-size').value;
    if (pageSize === 'all') {
        return totalDocuments > 0 ? totalDocuments : 1000;
    }
    return parseInt(pageSize);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    loadDocuments();

    // Add page size change listener
    document.getElementById('page-size').addEventListener('change', () => {
        currentOffset = 0;
        loadDocuments();
    });

    // Refresh every 30 seconds
    setInterval(() => {
        loadStats();
        loadDocuments();
    }, 30000);
});

// Load statistics
async function loadStats() {
    try {
        const response = await fetch(`${API_BASE}/api/stats`);
        const data = await response.json();

        document.getElementById('stat-total').textContent = data.total_documents || 0;
        document.getElementById('stat-anomalies').textContent = data.documents_with_anomalies || 0;
        document.getElementById('stat-flags').textContent = data.total_anomalies || 0;

        const rate = data.total_documents > 0
            ? ((data.documents_with_anomalies / data.total_documents) * 100).toFixed(1)
            : 0;
        document.getElementById('stat-rate').textContent = `${rate}%`;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Load documents with filters
async function loadDocuments(offset = 0) {
    try {
        const limit = getPageSize();
        const params = new URLSearchParams({
            limit: limit,
            offset: offset,
            ...currentFilters
        });

        const response = await fetch(`${API_BASE}/api/documents?${params}`);
        const data = await response.json();

        totalDocuments = data.total;
        renderDocumentsTable(data.results);
        renderPagination(data.total, offset);
    } catch (error) {
        console.error('Error loading documents:', error);
        document.getElementById('table-container').innerHTML =
            '<div class="empty-state"><h3>Error loading documents</h3></div>';
    }
}

// Render documents table
function renderDocumentsTable(documents) {
    const container = document.getElementById('table-container');

    if (!documents || documents.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <h3>No documents found</h3>
                <p>Try adjusting your filters or trigger a new scan.</p>
            </div>
        `;
        return;
    }

    let html = `
        <table>
            <thead>
                <tr>
                    <th>Document</th>
                    <th>Type</th>
                    <th>Anomalies</th>
                    <th>Balance Check</th>
                    <th>Layout Score</th>
                    <th>Processed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

    documents.forEach(doc => {
        // Store document in cache for modal access
        documentsCache[doc.id] = doc;

        // Generate anomaly badges with severity colors
        let anomalyBadges = '';
        if (doc.has_anomalies && doc.anomaly_types) {
            anomalyBadges = doc.anomaly_types.map(type => {
                // Find severity for this anomaly type from pattern_flags
                let severity = 'medium'; // default
                if (doc.pattern_flags) {
                    const flag = doc.pattern_flags.find(f => f.type === type);
                    if (flag && flag.severity) {
                        severity = flag.severity;
                    }
                }
                return `<span class="badge anomaly severity-${severity} clickable" onclick="showAnomalyDetails(${doc.id}, '${type}')">${formatAnomalyType(type)}</span>`;
            }).join('');
        } else {
            anomalyBadges = '<span class="badge clean">‚úì Clean</span>';
        }

        const balanceStatus = formatBalanceStatus(
            doc.balance_check_status,
            doc.balance_diff_amount,
            doc.beginning_balance,
            doc.ending_balance,
            doc.calculated_balance
        );
        const layoutScore = doc.layout_score !== null ? `${(doc.layout_score * 100).toFixed(0)}%` : '-';
        const processedDate = doc.processed_at ? new Date(doc.processed_at).toLocaleString() : '-';

        html += `
            <tr>
                <td>
                    <strong>${escapeHtml(doc.title || 'Untitled')}</strong><br>
                    <small style="color: #666;">ID: ${doc.paperless_doc_id}</small>
                </td>
                <td>${escapeHtml(doc.document_type || 'unknown')}</td>
                <td>${anomalyBadges}</td>
                <td>${balanceStatus}</td>
                <td>${layoutScore}</td>
                <td><small>${processedDate}</small></td>
                <td>
                    <a href="${doc.paperless_url}" target="_blank" class="link">View in Paperless</a>
                </td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    container.innerHTML = html;
}

// Render pagination
function renderPagination(total, offset) {
    const container = document.getElementById('table-container');
    const limit = getPageSize();
    const totalPages = Math.ceil(total / limit);
    const currentPage = Math.floor(offset / limit) + 1;

    // Don't show pagination if showing all results
    if (totalPages <= 1 || document.getElementById('page-size').value === 'all') return;

    let paginationHtml = '<div class="pagination">';

    if (currentPage > 1) {
        paginationHtml += `<button class="secondary" onclick="loadDocuments(${(currentPage - 2) * limit})">‚Üê Previous</button>`;
    }

    paginationHtml += `<span>Page ${currentPage} of ${totalPages} (${total} total)</span>`;

    if (currentPage < totalPages) {
        paginationHtml += `<button class="secondary" onclick="loadDocuments(${currentPage * limit})">Next ‚Üí</button>`;
    }

    paginationHtml += '</div>';
    container.innerHTML += paginationHtml;
}

// Apply filters
function applyFilters() {
    currentFilters = {};
    currentOffset = 0;

    // Get selected anomaly types from checkboxes
    const selectedTypes = Array.from(document.querySelectorAll('.anomaly-type-filter:checked'))
        .map(cb => cb.value);
    if (selectedTypes.length > 0) {
        // Note: API currently only supports single anomaly_type, so we'll use the first one
        // TODO: Update API to support multiple types
        currentFilters.anomaly_type = selectedTypes[0];
    }

    const minAmount = document.getElementById('filter-min-amount').value;
    if (minAmount) currentFilters.min_amount = minAmount;

    const maxAmount = document.getElementById('filter-max-amount').value;
    if (maxAmount) currentFilters.max_amount = maxAmount;

    const dateFrom = document.getElementById('filter-date-from').value;
    if (dateFrom) currentFilters.date_from = dateFrom;

    const dateTo = document.getElementById('filter-date-to').value;
    if (dateTo) currentFilters.date_to = dateTo;

    const hasAnomalies = document.getElementById('filter-has-anomalies').value;
    if (hasAnomalies) currentFilters.has_anomalies = hasAnomalies;

    loadDocuments();
}

// Clear filters
function clearFilters() {
    // Uncheck all anomaly type checkboxes
    document.querySelectorAll('.anomaly-type-filter').forEach(cb => cb.checked = false);

    document.getElementById('filter-min-amount').value = '';
    document.getElementById('filter-max-amount').value = '';
    document.getElementById('filter-date-from').value = '';
    document.getElementById('filter-date-to').value = '';
    document.getElementById('filter-has-anomalies').value = '';

    currentFilters = {};
    currentOffset = 0;
    loadDocuments();
}

// Trigger manual scan
async function triggerScan() {
    try {
        const response = await fetch(`${API_BASE}/api/trigger-scan`, {
            method: 'POST'
        });

        if (response.ok) {
            alert('Scan triggered successfully! Results will appear shortly.');
            setTimeout(() => {
                loadStats();
                loadDocuments();
            }, 5000);
        } else {
            alert('Failed to trigger scan');
        }
    } catch (error) {
        console.error('Error triggering scan:', error);
        alert('Error triggering scan');
    }
}

// Utility functions
function formatAnomalyType(type) {
    return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatBalanceStatus(status, diff, beginBal, endBal, calcBal) {
    if (!status || status === 'NOT_APPLICABLE') {
        return '<span style="color: #999;">N/A</span>';
    }

    if (status === 'PASS') {
        return '<span class="status-pass">‚úì Pass</span>';
    }

    if (status === 'FAIL') {
        let result = '<span class="status-fail">‚úó Fail</span>';
        if (diff !== null && diff > 0) {
            result += `<br><small style="color: #d9534f; font-weight: bold;">Diff: $${formatMoney(Math.abs(diff))}</small>`;
        }
        return result;
    }

    if (status === 'WARNING') {
        return '<span class="status-warning">‚ö† Warning</span>';
    }

    return `<span>${status}</span>`;
}

function formatMoney(amount) {
    return amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Modal functions
function showAnomalyDetails(docId, anomalyType) {
    const doc = documentsCache[docId];
    if (!doc) {
        console.error('Document not found:', docId);
        return;
    }

    const modal = document.getElementById('anomaly-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');

    // Set title
    modalTitle.textContent = `${formatAnomalyType(anomalyType)} - ${doc.title}`;

    // Build details HTML
    let detailsHtml = '';

    // Special handling for balance_mismatch
    if (anomalyType === 'balance_mismatch') {
        detailsHtml += '<div class="anomaly-detail-section">';
        detailsHtml += '<h3>Balance Check Failed</h3>';
        detailsHtml += '<div class="anomaly-detail-list">';

        if (doc.beginning_balance !== null && doc.ending_balance !== null && doc.calculated_balance !== null) {
            const diff = Math.abs(doc.balance_diff_amount || 0);
            detailsHtml += '<ul>';
            detailsHtml += `<li><strong>Beginning Balance:</strong> $${formatMoney(doc.beginning_balance)}</li>`;
            detailsHtml += `<li><strong>Calculated Balance:</strong> $${formatMoney(doc.calculated_balance)}</li>`;
            detailsHtml += `<li><strong>Statement Ending Balance:</strong> $${formatMoney(doc.ending_balance)}</li>`;
            detailsHtml += `<li><strong>Discrepancy:</strong> <span style="color: #e74c3c; font-weight: 600;">$${formatMoney(diff)}</span></li>`;
            detailsHtml += '</ul>';

            detailsHtml += '<p style="margin-top: 15px;"><strong>Explanation:</strong><br>';
            if (doc.calculated_balance > doc.ending_balance) {
                detailsHtml += `The statement shows an ending balance of $${formatMoney(doc.ending_balance)}, but based on the beginning balance of $${formatMoney(doc.beginning_balance)} plus deposits minus withdrawals, the balance should be $${formatMoney(doc.calculated_balance)}. This means $${formatMoney(diff)} is unaccounted for.`;
            } else {
                detailsHtml += `The statement shows an ending balance of $${formatMoney(doc.ending_balance)}, but based on the beginning balance of $${formatMoney(doc.beginning_balance)} plus deposits minus withdrawals, the balance should be $${formatMoney(doc.calculated_balance)}. This means there is an extra $${formatMoney(diff)} shown.`;
            }
            detailsHtml += '</p>';
        } else {
            detailsHtml += '<p>Balance check details not available.</p>';
        }

        detailsHtml += '</div></div>';
    }

    // Find the specific pattern flags for this anomaly type
    const flags = doc.pattern_flags ? doc.pattern_flags.filter(f => f.type === anomalyType) : [];

    if (flags.length === 0 && anomalyType !== 'balance_mismatch') {
        detailsHtml += '<p>No detailed information available for this anomaly.</p>';
    } else if (flags.length > 0) {
        flags.forEach(flag => {
            detailsHtml += '<div class="anomaly-detail-section">';
            detailsHtml += `<h3>${escapeHtml(flag.description || 'Details')}</h3>`;
            detailsHtml += '<div class="anomaly-detail-list">';

            if (flag.details && Array.isArray(flag.details) && flag.details.length > 0) {
                detailsHtml += '<ul>';
                flag.details.forEach(detail => {
                    detailsHtml += `<li><code>${escapeHtml(detail)}</code></li>`;
                });
                detailsHtml += '</ul>';
            } else if (flag.details && typeof flag.details === 'string') {
                detailsHtml += `<p>${escapeHtml(flag.details)}</p>`;
            }

            if (flag.match_count) {
                detailsHtml += `<p><strong>Occurrences:</strong> ${flag.match_count}</p>`;
            }

            if (flag.severity) {
                const severityColor = flag.severity === 'high' ? '#e74c3c' : flag.severity === 'medium' ? '#f39c12' : '#95a5a6';
                detailsHtml += `<p><strong>Severity:</strong> <span style="color: ${severityColor}; font-weight: 600;">${flag.severity}</span></p>`;
            }

            detailsHtml += '</div></div>';
        });
    }

    modalBody.innerHTML = detailsHtml;
    modal.classList.add('show');
}

function closeModal() {
    const modal = document.getElementById('anomaly-modal');
    modal.classList.remove('show');
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('anomaly-modal');
    if (event.target === modal) {
        closeModal();
    }
}

// Close modal on ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

</script>
</body>
</html>
